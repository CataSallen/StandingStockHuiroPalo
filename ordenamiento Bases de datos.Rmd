---
title: "Ordenamiento Bases de datos"
author: "Catalina Ruz"
date: "25 de septiembre de 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning=FALSE, error = F, message = F)
library(tidyverse) #metalibrary para ordenar 
library(knitr)
library(gridExtra)
library(kableExtra)
library(stringr)
library(broom)
library(MuMIn)
```

## Relación Talla-Peso 

Con datos obtenidos en 5 AMERB desde los 23º a los 36ºS, se estableció la relación entre el Diámetro máximo del disco y el peso del alga.
Con esta relación se estimaron los parámetros para establecer la relación alométrica dada por la ecuación:

$$
  \begin{aligned}
  B = aL^b 
  \end{aligned}
$$ 
```{r WL-rel, echo=FALSE}

Peso<-read.csv("pesoalgasIFOP.csv") %>% filter(Especie == "Lessonia trabeculata") %>% mutate(logPeso= log(peso), logDisco= log(Diametro.extraida)) %>% mutate(Latitude =rep("", times=length(AMERB), Longitud= rep("", times= length(AMERB))))
Peso$AMERB <- gsub("Quintay sector B", "Quintay protected", Peso$AMERB)
Peso$AMERB <- gsub("Quintay sector A", "Quintay protected", Peso$AMERB)


conQ= (Peso$AMERB== "Quintay protected")
Peso$Latitude[conQ] = "-33.185000"
Peso$Longitude[conQ] = "-71.691650"

conC= (Peso$AMERB== "Cobquecura")
Peso$Latitude[conC] = "-36.164765"
Peso$Longitude[conC] = "-72.816642"

conV= (Peso$AMERB== "Ventana")
Peso$Latitude[conV] = "-32.735717"
Peso$Longitude[conV] = "-71.503350"

conVi= (Peso$AMERB== "Los Vilos sector C")
Peso$Latitude[conVi] = "-31.934100"
Peso$Longitude[conVi] = "-71.517767"

conCa= (Peso$AMERB== "Carrizal Bajo")
Peso$Latitude[conCa] = "-28.040500"
Peso$Longitude[conCa] = "-71.152083"

conPY= (Peso$AMERB== "Punta el Yeso")
Peso$Latitude[conPY] = "-23.415222"
Peso$Longitude[conPY] = "-70.600943"

ggplot(Peso, aes(x=Diametro.extraida , y=peso, group=Latitude))+ geom_point(aes(color=Latitude))

ggplot(Peso, aes(x=logDisco , y=logPeso, group=Latitude))+ geom_point(aes(color=Latitude))
#model<-lm(logPeso~logDisco, data=Peso)
#summary(model)
#model1<-lm(log(peso)~log(Diametro.extraida)+AMERB, data=Peso)
#summary(model1)
#model2<-nls(peso~Diametro.extraida+AMERB, data=Peso)
#summary(model2)

model3<-glm(peso~I(log(Diametro.extraida))+AMERB, family = quasipoisson, data=Peso)
summary(model3)
anova(model3, test = "F")
```

En base a esta relación se estimó la pendiente 2.12524 y el intercepto -5.29154. El modelo indica que hay un efecto de la localidad en esta relación, por lo que no todos los sitios presentan la misma pendiente. Sin embargo, sólo la localidad de Los Vilos está generando estas diferencias significativas y los datos de estructura de tallas que serán utilizados para las estimaciones de biomasa no corresponden a esta localidad, por lo que utilizaremos los parametros obtenidos para todas las localidades.

En función de estos parametros, la ecuación se resuelve mediante la transformación a logaritmo de las variables, y se remplazan los parametros en la ecuación:
$$
  \begin{aligned}
log(B) =-5.29154 + 2.12524 * log(L)
  \end{aligned}
$$
$$  
  \begin{aligned}
B =e^(-5.29154) * (L)^(2.12524)
  \end{aligned}
$$

$$
\begin{aligned}
B= 0.0026*L^(2.12524)
\end{aligned}
$$

```{r lm-Sitio, eval= F}

## LINEAL MODEL PARA CADA SITIO

Quintay<- Peso %>% filter(AMERB == "Quintay")
Q<-lm(log(Diametro.extraida)~log(peso), data= Quintay)
plot1<-ggplot(Quintay, aes(x=Diametro.extraida , y=peso))+ geom_smooth(model=lm)
tidy(Q)


Carrizal<- Peso %>% filter(AMERB == "Carrizal Bajo")
Ca<-lm(log(Diametro.extraida)~log(peso), data= Carrizal)
plot2<-ggplot(Carrizal, aes(x=Diametro.extraida , y=peso))+geom_smooth(model=lm)
tidy(Ca) 

Cobquecura<- Peso %>% filter(AMERB == "Cobquecura")
Co<-lm(log(Diametro.extraida)~log(peso), data= Cobquecura)
plot3<-ggplot(Cobquecura, aes(x=Diametro.extraida , y=peso))+ geom_smooth(model=lm)
tidy(Co) 

LosVilos<- Peso %>% filter(AMERB == "Los Vilos sector C")
V<-lm(log(Diametro.extraida)~log(peso), data= LosVilos)
plot4<-ggplot(LosVilos, aes(x=Diametro.extraida , y=peso))+ geom_smooth(model=lm)
tidy(V) 

PuntaYeso<-Peso %>% filter(AMERB == "Punta el Yeso")
PY<-lm(log(Diametro.extraida)~log(peso), data= PuntaYeso)
plot5<-ggplot(PuntaYeso, aes(x=Diametro.extraida , y=peso))+ geom_smooth(model=lm)
tidy(PY) 

Ventana<- Peso %>% filter(AMERB == "Ventana")
Ve<-lm(log(Diametro.extraida)~log(peso), data= Ventana)
plot6<-ggplot(Ventana, aes(x=Diametro.extraida , y=peso))+ geom_smooth(model=lm)
tidy(Ve) 

grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, nrow = 3)

```

##Estimación Stanging stock
###Bases de datos
A partir de diferentes proyectos desde el años 2012 a la fecha se obtuvo información de la estructura de tallas de L. trabeculata.

###2012-2014
Primera base de datos proviene de un proyecto fondecytF11110351, y tiene información obtenida en terreno de las temporadas de otoño y primavera en los años 2012-2013 y para la temporada de verano del año 2014.

Los monitoreos se realizaron a través de 2 transectos de 100 m perpendiculares a la costa, donde se evaluó la abundancia y diámetro del disco de las macroalgas en cuadrantes de 1m^2^ a cada lado del transecto en estaciones cada 10 m.

```{r 2012-2014}
F11110351<-read.csv("2012-2014.csv") %>% filter(Subset == "Kelp") %>% select(-c(Subset,Transects,Temperature, Visbility,DepthRange,Holdfast.Use,Blade.Use,Cover, allometric, a,b, Biomass)) %>% mutate(DF= rep("F11110351", times= length(Site)), Stipes= rep("NA", times=length(Site)), Length=rep("NA", times=length(Site)))
F11110351$Site<-as.character(F11110351$Site)

##cambio de nombre a un sitio para std con otras bd
F11110351$Site <- gsub("LosMolles", "Los Molles protected", F11110351$Site)
condYF12= (F11110351$Season== "Fall2012")
F11110351$Year[condYF12] = "2012"
condYS12= (F11110351$Season== "Spring2012")
F11110351$Year[condYS12] = "2012"
condYF13= (F11110351$Season== "Fall2013")
F11110351$Year[condYF13] = "2013"
condYS13= (F11110351$Season== "Spring2013")
F11110351$Year[condYS13] = "2013"
condYSu14= (F11110351$Season== "Summer 2014")
F11110351$Year[condYSu14] = "2014"
```

###2015
La segunda base de datos proviene del proyecto fondecyt F1140841 donde se realizó un sólo muestreo durante la temporada de verano 2015, en transectos de 50 m perpendiculares a la costa, donde se medió la abundancia de algas y morfología de las algas (incluyendo el diámetro del disco) en cuadrantes de 1m^2^ a cada lado del transecto en estaciones cada 10 m.

```{r 2015}

F1140841<-read.csv("2015.csv") %>% filter(Subset == "kelp") %>% select(-c(Subset,Temperature, Visbility, Holdfast.Use,Blade.Use,Cover...,X,Biomass)) %>% mutate(DF= rep("F1140841", times= length(Site)), Length=rep("NA", times=length(Site))) %>% rename(Stipes= "no..stipes", Size= "Size.cm.", Station="station")

F1140841$Site <- gsub("Quintay", "QuintayAMERB", F1140841$Site)
F1140841$Site <- gsub("El Franc\x8es", "TotoralilloOA", F1140841$Site)
F1140841$Site <- gsub("Algarrobo", "AlgarroboOA", F1140841$Site)
F1140841$Season <- gsub("summer 2014", "summer2014", F1140841$Season)
#Rellenar coordenadas

cond1= (F1140841$Site== "AlgarroboOA")
F1140841$Latitude[cond1] = "-33.36483661"
F1140841$Longitude[cond1] = "-71.69101847"

cond2= (F1140841$Site== "TotoralilloOA")
F1140841$Latitude[cond2] = "-30.0939569"
F1140841$Longitude[cond2] = "-71.37972619"

cond3= (F1140841$Site== "QuintayAMERB")
F1140841$Latitude[cond3] = "-33.19193931"
F1140841$Longitude[cond3] = "-71.70033633"

condYSu14.2= (F1140841$Season== "summer2014")
F1140841$Year[condYSu14.2] = "2014"
```

###2015-2017

La tercera base de datos proviene del proyecto fondecyt 1151094 donde se realizaron muestreos en dos localidades de la V región, Quintay y Los Molles. En cada sitio se realizaron monitoreos en una zona expuesta y en una zona protegida. En cada zona se muestrearon las algas en cuadrantes de 1m2, en 6 transectos de 25 m perpendiculares a la costa, 3 fueron realizados en zonas profundas (15 m) y 3 en zonas someras (5m). Los  cuadrantes fueron dispuestos en estaciones cada 5 metros.

```{r 2015-2016}
F1151094<-read.csv("2015-2017.csv") %>% filter(Habitat == "kelp") %>% 
  select(-c(Survey,Habitat,Sampler, High.1,High.2, Mean.High,comentario,Data_Entry,Num_parches)) %>%
  mutate(DF=rep("F1151094", times=611), Year=rep("NA", times=length(Site)),Season=rep("NA", times=length(Site)), Latitude=rep("NA", times=length(Site)), Longitude=rep("NA", times=length(Site)), Phase=rep("NA", times=length(Site))) %>% rename(Series ="serie",  Station= "Station.replicate", Replicate= "Pseudoreplicate",Size= "Width")


#Cambio de nombre de los sitios
F1151094$Site[F1151094$Site == "Quintay "] = "Quintay"
F1151094$Site[F1151094$Site == "LosMolles"] = "Los Molles"
F1151094$Site <- paste(F1151094$Site,F1151094$Exposure)
##Rellenamos las columnas de latitud y longitud
condicion1= (F1151094$Site== "Quintay exposed")
condicion2= (F1151094$Site== "Quintay protected")
condicion5= (F1151094$Site== "Quintay protected")
condicion3= (F1151094$Site== "Los Molles exposed")
condicion4= (F1151094$Site== "Los Molles protected")
#Completamos las coordenadas
F1151094$Latitude[condicion1] = "-33.143806"
F1151094$Longitude[condicion1]= "-71.711944"
F1151094$Latitude[condicion2] = "-33.19193931"
F1151094$Longitude[condicion2] = "-71.70033633"
F1151094$Latitude[condicion3] = "-32.23857"
F1151094$Longitude[condicion3] = "-71.52684"
F1151094$Latitude[condicion4] = "-32.230642"
F1151094$Longitude[condicion4] = "-71.523598"
#Cada sitio tiene una zona profunda y en cada zona hay tres transectos, y debería ponerles 1, 2 , 3...4, 5, 6....Cada sitio tiene una zona profunda y en cada zona hay tres transectos, y debería ponerles 1, 2 , 3...4, 5, 6....
#Finalmente también hay que agregar Season, dependiendo de la fecha ...
#10-11-15 11-11-15 -> Primavera 2015
#05-04-16 13-04-16 -> Otoño 2016
#29-08-17 30-08-17 31-08-17-> Invierno 2017
#16-12-16 ->verano 2017
condicion5=(F1151094$Zone =="shallow") & (F1151094$Transect =="1")
F1151094$Transect[condicion5] = "4"
condicion6=(F1151094$Zone =="shallow") & (F1151094$Transect =="2")
F1151094$Transect[condicion6] = "5"
condicion7=(F1151094$Zone =="shallow") & (F1151094$Transect =="3")
F1151094$Transect[condicion7] = "6"
F1151094std= F1151094 %>% select(-c(Exposure,Zone)) %>% mutate(Season=rep("NA", times=length(Site)))
F1151094std$Site <- gsub("Quintay protected", "QuintayAMERB", F1151094std$Site)
```

###Variación temporal y latitudinal
Se evaluó como varió el standing stock en 7 sitios de la IV y V regiones, desde `r min(Site$Latitude)` hasta `r max(Site$Latitude)`º S, durante los años 2012 y 2013 en temporadas de otoño y primavera. 


```{r Alldata-Biomass, echo= F}

#unir las 3 bases de datos y calculo de biomasa con los parametros obtenidos 
Alldata= rbind(F11110351,F1140841,F1151094std)
Alldata$Size<-as.numeric(Alldata$Size)
#Según de B= 0.0026*L^(2.12524)
Alldata$Biomass= (0.0026)*((Alldata$Size)^(2.12524))

Quad<-Alldata %>% filter(DF=="F11110351", Season !="Summer 2014") %>% group_by(Season,Site,Latitude,Transect, Station, Replicate) %>% summarise(Biomassm2= sum(Biomass))
Station<-Quad %>% group_by(Season, Site, Latitude, Transect, Station) %>% summarise(meanStation=mean(Biomassm2))
Transect<-Station %>% group_by(Season, Site, Latitude, Transect) %>% summarise(meanTransect=mean(meanStation))
Site<-Transect  %>% group_by(Season, Site, Latitude) %>% summarise(Biomassbysite=mean(meanTransect), se=sd(meanTransect)/sqrt(length(Transect)))

Seasonvar<-ggplot(Site, aes(x=Latitude, y=Biomassbysite, fill= fct_relevel(Season, "Fall2012", "Spring2012","Fall2013", "Spring2013"))) + geom_bar(position = "dodge", stat = "identity", size =.2)+scale_fill_hue(l=40, c=35)+
labs(x= "Season" ,y="Biomasa/m2", fill="Season")+
geom_errorbar(aes(ymin=Biomassbysite-se, ymax= Biomassbysite+se),width=.2,
position=position_dodge(.9))+ theme_classic()
#+facet_wrap(Site~., ncol=1)
Seasonvar

Site$Season<- factor(Site$Season, levels = c("Fall2012", "Spring2012","Fall2013", "Spring2013"))
Latitudvar<- ggplot(Site, aes(x=fct_relevel(Site, "CaletaHornosOA",
"TotoralilloOA","PuntatalcaAMERB", "Los Molles protected", "ZapallarAmerb","QuintayAMERB","AlgarroboOA"), y=Biomassbysite))+ ggtitle('Biomasa Lessonia trabeculata')+
geom_bar(position = "dodge", stat = "identity", size =.2)+
labs(x= "Sitios" ,y="Biomasa/m2")+
geom_errorbar(aes(ymin=Biomassbysite-se, ymax= Biomassbysite+se),width=.2,
position=position_dodge(.9))+ theme_classic()+facet_wrap(Season~., ncol=1, nrow = 4)
Latitudvar

model1<-glm(meanTransect~Latitude*Season, family= quasipoisson, data=Transect)##Identificar qué formula se debe hacer (+ o *)
summary(model1)
anova(model1, test = "F")

```

###2018 y 2019

```{r}

ifop18<-read.csv("2018.csv") %>% filter(Especie == "Lessonia trabeculata") %>% select(-c(Dia,Mes,Year,Tipo.de.especie,Presencia,Abundancia.en.alga,Abundancia.en.sustrato,Chico..total,Chico.en.alga,Chico.en.sustrato,Mediano.total,Mediano.en.alga,Mediano.en.sustrato,Grande.total,Grande.en.alga,Grande.en.sustrato,Observaciones,Muestreado.por,Anotado.por,Ingresado.por)) %>% rename(Series="Serie", Date= "Fecha", Site= "AMERB", Transect="Transecto", Replicate="Cuadrante", Depth="Profundidad..m.", Species="Especie", Abundance="Abundancia.total",Size="Diametro.del.disco", Stipes="No.estipes",Length = "Largo") %>% mutate(Season=rep("NA", times=702), DF= rep("ifop2018", times= 702),Year= rep("2018", times= 702), Station=replicate(1, Replicate),Phase= rep("NA", times=702),Frondosity= rep("NA", times=702)) 

##Cambiar nombre de los sitios
ifop18$Site <- gsub("Quintay sector B", "Quintay sur", ifop18$Site)
ifop18$Site <- gsub("Quintay sector A", "Quintay protected", ifop18$Site)
ifop18$Site <- gsub("Cha\x96aral de aceituno sector C", "Chanaral AMERB", ifop18$Site)
ifop18$Site <- gsub("Reserva Cha\x96aral de aceituno", "Chanaral Reserva", ifop18$Site)
##Definir coordenadas

condicion8= (ifop18$Site== "Carrizal bajo")
ifop18$Latitude[condicion8]="-28.040500" 
ifop18$Longitude[condicion8]="-71.152083"
  
condicion9= (ifop18$Site== "Chanaral AMERB")
ifop18$Latitude[condicion9]="-29.132117" 
ifop18$Longitude[condicion9]="-71.489500"

condicion10= (ifop18$Site== "Cobquecura")
ifop18$Latitude[condicion10]="-36.164765" 
ifop18$Longitude[condicion10]="-72.816642"

condicion11= (ifop18$Site== "ECIM")
ifop18$Latitude[condicion11]="-33.504383" 
ifop18$Longitude[condicion11]="-71.633250"
  
condicion12= (ifop18$Site== "Los Vilos sector C")
ifop18$Latitude[condicion12]="-31.934100"
ifop18$Longitude[condicion12]="-71.517767"
  
condicion13= (ifop18$Site== "Punta el Yeso")
ifop18$Latitude[condicion13]="-23.415222" 
ifop18$Longitude[condicion13]="-70.600943"

condicion14= (ifop18$Site== "Quintay protected")
ifop18$Latitude[condicion14]="-33.185000" 
ifop18$Longitude[condicion14]="-71.691650"

condicion15= (ifop18$Site== "Quintay sur")
ifop18$Latitude[condicion15]="-33.204333" 
ifop18$Longitude[condicion15]="-71.703750"

condicion16= (ifop18$Site== "Chanaral Reserva")
ifop18$Latitude[condicion16]="-29.025167" 
ifop18$Longitude[condicion16]="-71.565917"

condicion17= (ifop18$Site== "Ventanas")
ifop18$Latitude[condicion17]="-32.735717" 
ifop18$Longitude[condicion17]="-71.503350"

 
####LAS COORDENADAS DE QUINTAY ESTAN EQUIVOCADAS EN EL DF PESO!!!

ifop19<-read.csv("2019.csv")

```


##
